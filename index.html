<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyond the Curve - Your Scoliosis Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .active-nav {
            background-color: #15803d; /* Green-700 */
            color: white;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .sp-bubble {
            max-width: 80%;
        }
        .sp-bubble.user {
            background-color: #bbf7d0; /* Green-200 */
        }
        .sp-bubble.spiney {
            background-color: #f3f4f6; /* Gray-100 */
        }
        .sp-typing-indicator span {
            animation: bounce 1s infinite;
        }
        .sp-typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .sp-typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .protected-content { display: none; }
        .login-prompt { display: block; }
        .logged-in .protected-content { display: block; }
        .logged-in .login-prompt { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto min-h-screen bg-white shadow-lg flex flex-col">
        <!-- Header -->
        <header class="bg-green-700 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-3">
                 <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="white" fill-opacity="0.2"/>
                    <path d="M12 5C8.13401 5 5 8.13401 5 12C5 15.866 8.13401 19 12 19C15.866 19 19 15.866 19 12C19 8.13401 15.866 5 12 5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" transform="rotate(25 12 12)"/>
                </svg>
                <h1 class="text-2xl font-bold">Beyond the Curve</h1>
            </div>
            <div id="auth-container" class="flex items-center gap-4">
                 <nav class="hidden md:flex space-x-2">
                    <button data-page="home" class="nav-link active-nav px-4 py-2 rounded-lg font-semibold">Home</button>
                    <button data-page="tracker" class="nav-link px-4 py-2 rounded-lg font-semibold">Brace Tracker</button>
                    <button data-page="physio" class="nav-link px-4 py-2 rounded-lg font-semibold">Physiotherapy</button>
                    <button data-page="journal" class="nav-link px-4 py-2 rounded-lg font-semibold">Journal</button>
                    <button data-page="spiney" class="nav-link px-4 py-2 rounded-lg font-semibold">Spiney âœ¨</button>
                    <button data-page="resources" class="nav-link px-4 py-2 rounded-lg font-semibold">Resources</button>
                </nav>
                 <button id="login-button" class="bg-white text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">Login with Google</button>
                 <div id="user-profile" class="hidden items-center gap-2">
                    <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User avatar">
                    <button id="logout-button" class="font-semibold hover:underline">Logout</button>
                </div>
            </div>
            <button id="mobile-menu-button" class="md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-green-600 text-white">
            <nav class="flex flex-col items-center">
                <button data-page="home" class="nav-link w-full text-center py-3">Home</button>
                <button data-page="tracker" class="nav-link w-full text-center py-3">Brace Tracker</button>
                <button data-page="physio" class="nav-link w-full text-center py-3">Physiotherapy</button>
                <button data-page="journal" class="nav-link w-full text-center py-3">Journal</button>
                <button data-page="spiney" class="nav-link w-full text-center py-3">Spiney âœ¨</button>
                <button data-page="resources" class="nav-link w-full text-center py-3">Resources</button>
            </nav>
        </div>

        <main class="p-4 md:p-8 flex-grow">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="bg-green-100 border-l-4 border-green-600 text-green-800 p-6 rounded-lg shadow-md relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-2">Welcome to Your Journey Companion</h2>
                        <p class="text-lg">You're not alone. We're here to empower you with tools, community, and resources to build confidence and resilience. Let's navigate this journey together.</p>
                    </div>
                     <svg class="absolute -bottom-10 -right-10 text-green-200 w-48 h-48 opacity-50" fill="currentColor" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M100 200C155.228 200 200 155.228 200 100C200 44.7715 155.228 0 100 0C44.7715 0 0 44.7715 0 100C0 155.228 44.7715 200 100 200ZM100 180C144.183 180 180 144.183 180 100C180 55.8172 144.183 20 100 20C55.8172 20 20 55.8172 20 100C20 144.183 55.8172 180 100 180Z" fill-opacity="0.5"/>
                        <path d="M100 5C152.467 5 195 47.5329 195 100C195 152.467 152.467 195 100 195C47.5329 195 5 152.467 5 100C5 47.5329 47.5329 5 100 5Z" stroke="currentColor" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" transform="rotate(30 100 100)"/>
                    </svg>
                </div>

                <div class="mt-8 grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow flex flex-col">
                        <div class="flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold text-green-700">Daily Brace Tracker</h3>
                        </div>
                        <p class="mt-4 flex-grow">Log your brace hours, watch your progress, and earn rewards. Your data is saved securely to your Google Drive.</p>
                        <button data-page="tracker" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors self-start">Go to Tracker</button>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow flex flex-col">
                        <div class="flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M12 6v6h.01"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold text-green-700">Physiotherapy Tracker</h3>
                        </div>
                        <p class="mt-4 flex-grow">Track your daily PT sessions and stay consistent with your exercises. Data is saved securely to your Google Drive.</p>
                        <button data-page="physio" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors self-start">Go to PT Tracker</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow flex flex-col">
                         <div class="flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-5.247-8.247l10.494 4.498-10.494 3.749zM3.75 6.253L14.244 1.75l-3.749 10.494L3.75 6.253zM12 6.253l8.247 5.247-10.494-3.749L12 6.253z"></path></svg>
                             </div>
                            <h3 class="text-xl font-bold text-green-700">Reflection Journal</h3>
                        </div>
                        <p class="mt-4 flex-grow">A private space to write, with data saved securely to your Google Drive.</p>
                        <button data-page="journal" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors self-start">Open Journal</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow flex flex-col">
                        <div class="flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold text-green-700">Chat with Spiney âœ¨</h3>
                        </div>
                        <p class="mt-4 flex-grow">Your AI companion is here to answer questions and offer support 24/7.</p>
                        <button data-page="spiney" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors self-start">Talk to Spiney</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow flex flex-col">
                        <div class="flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4h5m-5 4h5"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold text-green-700">Vetted Resources</h3>
                        </div>
                        <p class="mt-4 flex-grow">Find surgeons, brace-friendly apparel, support groups, and helpful videos all in one place.</p>
                        <button data-page="resources" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors self-start">Explore Resources</button>
                    </div>
                </div>
            </div>

            <!-- Brace Tracker Page -->
            <div id="tracker-page" class="page">
                <div class="login-prompt text-center p-8 bg-gray-100 rounded-lg">
                    <h3 class="text-2xl font-bold mb-4">Login to Track Your Progress</h3>
                    <p class="mb-6">Please log in with your Google account to use the Brace Tracker. Your data will be stored safely in your own Google Drive.</p>
                    <button id="login-button-tracker" class="bg-green-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-800 transition-colors">Login with Google</button>
                </div>
                <div class="protected-content">
                    <div class="flex items-center justify-center gap-3 mb-6">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-3xl font-bold text-center">My Brace Tracker</h2>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4">Log Today's Hours</h3>
                            <form id="brace-form" class="space-y-4">
                                <div>
                                    <label for="brace-date" class="block font-semibold">Date</label>
                                    <input type="date" id="brace-date" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required>
                                </div>
                                <div>
                                    <label for="brace-hours" class="block font-semibold">Hours Worn</label>
                                    <input type="number" id="brace-hours" min="0" max="24" step="0.5" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="e.g., 18.5" required>
                                </div>
                                <div>
                                    <label for="daily-goal" class="block font-semibold">Daily Goal (hours)</label>
                                    <input type="number" id="daily-goal" min="1" max="24" step="1" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="18">
                                </div>
                                <button type="submit" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold hover:bg-green-800 transition-colors">Log Hours</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4">Today's Progress</h3>
                            <div id="progress-container">
                                <div class="w-full bg-gray-200 rounded-full h-8">
                                    <div id="progress-bar" class="progress-bar-fill bg-green-600 h-8 text-white text-center font-bold leading-8 rounded-full" style="width: 0%;">0%</div>
                                </div>
                                <p id="progress-text" class="text-center mt-2 font-semibold">Log your hours to see your progress!</p>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-xl font-bold mb-4">My Rewards</h3>
                                <div id="rewards-container" class="flex flex-wrap gap-4">
                                    <p class="text-gray-500">Start logging to earn badges!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold mb-4">Weekly Progress</h3>
                         <canvas id="brace-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Physiotherapy Tracker Page -->
            <div id="physio-page" class="page">
                <div class="login-prompt text-center p-8 bg-gray-100 rounded-lg">
                    <h3 class="text-2xl font-bold mb-4">Login to Track Your Physiotherapy</h3>
                    <p class="mb-6">Please log in with your Google account to use the PT Tracker. Your data will be stored safely in your own Google Drive.</p>
                    <button id="login-button-physio" class="bg-green-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-800 transition-colors">Login with Google</button>
                </div>
                <div class="protected-content">
                    <div class="flex items-center justify-center gap-3 mb-6">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M12 6v6h.01"></path></svg>
                        <h2 class="text-3xl font-bold text-center">My Physiotherapy Tracker</h2>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4">Log Today's Session</h3>
                            <form id="physio-form" class="space-y-4">
                                <div>
                                    <label for="physio-date" class="block font-semibold">Date</label>
                                    <input type="date" id="physio-date" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required>
                                </div>
                                <div>
                                    <label for="physio-minutes" class="block font-semibold">Minutes of PT</label>
                                    <input type="number" id="physio-minutes" min="0" max="240" step="1" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="e.g., 45" required>
                                </div>
                                <div>
                                    <label for="physio-daily-goal" class="block font-semibold">Daily Goal (minutes)</label>
                                    <input type="number" id="physio-daily-goal" min="1" max="240" step="1" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="30">
                                </div>
                                <button type="submit" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold hover:bg-green-800 transition-colors">Log Session</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4">Today's Progress</h3>
                            <div id="physio-progress-container">
                                <div class="w-full bg-gray-200 rounded-full h-8">
                                    <div id="physio-progress-bar" class="progress-bar-fill bg-green-600 h-8 text-white text-center font-bold leading-8 rounded-full" style="width: 0%;">0%</div>
                                </div>
                                <p id="physio-progress-text" class="text-center mt-2 font-semibold">Log your session to see your progress!</p>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-xl font-bold mb-4">My PT Rewards</h3>
                                <div id="physio-rewards-container" class="flex flex-wrap gap-4">
                                    <p class="text-gray-500">Start logging to earn badges!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold mb-4">Weekly PT Progress</h3>
                         <canvas id="physio-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Journal Page -->
            <div id="journal-page" class="page">
                 <div class="login-prompt text-center p-8 bg-gray-100 rounded-lg">
                    <h3 class="text-2xl font-bold mb-4">Login to Use Your Journal</h3>
                    <p class="mb-6">Please log in with your Google account to use the Reflection Journal. Your entries will be stored safely and privately in your own Google Drive.</p>
                    <button id="login-button-journal" class="bg-green-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-800 transition-colors">Login with Google</button>
                </div>
                <div class="protected-content">
                    <div class="flex items-center justify-center gap-3 mb-6">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-5.247-8.247l10.494 4.498-10.494 3.749zM3.75 6.253L14.244 1.75l-3.749 10.494L3.75 6.253zM12 6.253l8.247 5.247-10.494-3.749L12 6.253z"></path></svg>
                        <h2 class="text-3xl font-bold">My Reflection Journal</h2>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <form id="journal-form">
                            <h3 class="text-xl font-bold mb-2">New Entry</h3>
                            <p class="text-gray-600 mb-4">How are you feeling today? This is your private space.</p>
                            <textarea id="journal-entry" class="w-full p-3 border border-gray-300 rounded-lg" rows="8" placeholder="Write about your day, your thoughts, or anything on your mind..."></textarea>
                            <div class="flex justify-end mt-4">
                                <button type="submit" class="bg-green-700 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-800 transition-colors">Save Entry</button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-2xl font-bold mb-4">Past Entries</h3>
                        <div id="journal-entries-container" class="space-y-6">
                            <p class="text-gray-500">Your saved entries will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Spiney AI Companion Page -->
            <div id="spiney-page" class="page h-full flex flex-col">
                <div class="text-center mb-4">
                    <div class="w-32 h-32 mx-auto mb-4">
                        <!-- Spiney the Cactus Mascot -->
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                          <g transform="translate(0, -5)">
                            <path d="M50 85C40 85 40 75 40 75V55C40 45 50 45 50 45C60 45 60 55 60 55V75C60 75 60 85 50 85Z" fill="#4ade80"/>
                            <path d="M40 65C30 65 30 55 30 55V45C30 35 40 35 40 35" stroke="#16a34a" stroke-width="5" stroke-linecap="round" fill="none"/>
                            <path d="M60 65C70 65 70 55 70 55V45C70 35 60 35 60 35" stroke="#16a34a" stroke-width="5" stroke-linecap="round" fill="none"/>
                            <circle cx="45" cy="60" r="2" fill="white"/>
                            <circle cx="55" cy="60" r="2" fill="white"/>
                            <path d="M47 68C48 70 52 70 53 68" stroke="white" stroke-width="1.5" stroke-linecap="round" fill="none"/>
                          </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold">Chat with Spiney âœ¨</h2>
                    <p class="text-gray-600">Your friendly AI companion. Ask me anything!</p>
                </div>
                <div id="spiney-chat-window" class="flex-grow bg-white border border-gray-200 rounded-xl p-4 overflow-y-auto space-y-4">
                </div>
                <form id="spiney-form" class="mt-4 flex gap-2">
                    <input type="text" id="spiney-input" class="flex-grow w-full p-3 border border-gray-300 rounded-lg" placeholder="Type your message to Spiney..." autocomplete="off">
                    <button type="submit" class="bg-green-700 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-800 transition-colors disabled:bg-green-300">Send</button>
                </form>
                 <p class="text-xs text-gray-500 mt-2 text-center">Spiney is an AI assistant and may not be 100% accurate. It is not a substitute for medical advice. Please consult a doctor for health concerns.</p>
            </div>

            <!-- Resources Page -->
            <div id="resources-page" class="page">
                 <div class="flex items-center justify-center gap-3 mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4h5m-5 4h5"></path></svg>
                    <h2 class="text-3xl font-bold mb-6">Vetted Resources</h2>
                 </div>
                <div class="space-y-8">
                    <!-- Scoliosis Specialists -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-4 text-green-800">Scoliosis Specialists</h3>
                        <p class="mb-4 text-gray-600">
                            For the most comprehensive and up-to-date directory of specialists, we strongly recommend using the official Scoliosis Research Society (SRS) physician locator. It is the best resource for finding a qualified professional in your area.
                        </p>
                        <a href="https://www.srs.org/Patients/Find-a-Specialist#" target="_blank" rel="noopener noreferrer" class="inline-block bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                            Visit SRS Find a Specialist &rarr;
                        </a>
                    </div>

                    <!-- Other Resources -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Video Library</h3>
                            <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Understanding Scoliosis</a></li>
                                <li><a href="#" class="hover:underline">Physical Therapy Exercises</a></li>
                                <li><a href="#" class="hover:underline">Inspiring Patient Stories</a></li>
                                <li><a href="#" class="hover:underline">Bracing: Tips & Tricks</a></li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Brace-Friendly Apparel</h3>
                             <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Hope's Closet</a></li>
                                <li><a href="#" class="hover:underline">Brace-Tee</a></li>
                                <li><a href="#" class="hover:underline">Embraced in Comfort</a></li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Support Groups</h3>
                             <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Curvy Girls International</a></li>
                                <li><a href="#" class="hover:underline">ScoliBoys Support</a></li>
                                <li><a href="#" class="hover:underline">Higgy Bears</a></li>
                                <li><a href="https://www.bracingforscoliosus.org/" target="_blank" rel="noopener noreferrer" class="hover:underline">Bracing for Scoliosis</a></li>
                                 <li><a href="#" class="hover:underline">Parents of Scoliosis Facebook Group</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center p-4 bg-gray-100 border-t mt-auto">
            <p class="text-sm text-gray-500">Visitor Count: <span id="visitor-counter">0</span></p>
        </footer>
    </div>
        <script>
        const app = {
            // STATE
            geminiApiKey: "AIzaSyAkrSD-tH4a2wTwh3J1Y1uPdOKXnpvlqKE", // Injected by environment
            googleApiReady: false,
            googleGisReady: false,
            tokenClient: null,
            accessToken: null, // Store the access token directly
            fileId: null,
            isLoggedIn: false,
            userInfo: null, // To store user profile info
            
            // UI ELEMENTS
            pages: null, navLinks: null, mobileMenuButton: null, mobileMenu: null,
            loginButton: null, loginButtonTracker: null, loginButtonJournal: null, loginButtonPhysio: null,
            logoutButton: null, userProfile: null, userAvatar: null, appContainer: null,

            // Brace Tracker
            braceForm: null, braceDate: null, braceHours: null, dailyGoal: null,
            progressBar: null, progressText: null, rewardsContainer: null, braceChart: null,
            braceData: {},
            
            // Physio Tracker
            physioForm: null, physioDate: null, physioMinutes: null, physioDailyGoal: null,
            physioProgressBar: null, physioProgressText: null, physioRewardsContainer: null, physioChart: null,
            physioData: {},

            // Journal
            journalForm: null, journalEntry: null, journalEntriesContainer: null,
            journalData: [],

            // Spiney AI Companion
            spineyForm: null, spineyInput: null, spineyChatWindow: null,
            spineyChatHistory: [],
            
            // --- INITIALIZATION ---
            async init() {
                // Defer setup until both Google APIs are loaded
                if (this.googleApiReady && this.googleGisReady) {
                    await this.setupApp();
                }
            },

            async setupApp() {
                // Query selectors
                this.appContainer = document.getElementById('app');
                this.pages = document.querySelectorAll('.page');
                this.navLinks = document.querySelectorAll('.nav-link');
                this.mobileMenuButton = document.getElementById('mobile-menu-button');
                this.mobileMenu = document.getElementById('mobile-menu');
                this.loginButton = document.getElementById('login-button');
                this.loginButtonTracker = document.getElementById('login-button-tracker');
                this.loginButtonJournal = document.getElementById('login-button-journal');
                this.loginButtonPhysio = document.getElementById('login-button-physio');
                this.logoutButton = document.getElementById('logout-button');
                this.userProfile = document.getElementById('user-profile');
                this.userAvatar = document.getElementById('user-avatar');
                
                // Brace Tracker elements
                this.braceForm = document.getElementById('brace-form');
                this.braceDate = document.getElementById('brace-date');
                this.braceHours = document.getElementById('brace-hours');
                this.dailyGoal = document.getElementById('daily-goal');
                this.progressBar = document.getElementById('progress-bar');
                this.progressText = document.getElementById('progress-text');
                this.rewardsContainer = document.getElementById('rewards-container');
                
                // Physio Tracker elements
                this.physioForm = document.getElementById('physio-form');
                this.physioDate = document.getElementById('physio-date');
                this.physioMinutes = document.getElementById('physio-minutes');
                this.physioDailyGoal = document.getElementById('physio-daily-goal');
                this.physioProgressBar = document.getElementById('physio-progress-bar');
                this.physioProgressText = document.getElementById('physio-progress-text');
                this.physioRewardsContainer = document.getElementById('physio-rewards-container');

                // Journal elements
                this.journalForm = document.getElementById('journal-form');
                this.journalEntry = document.getElementById('journal-entry');
                this.journalEntriesContainer = document.getElementById('journal-entries-container');
                
                // Spiney elements
                this.spineyForm = document.getElementById('spiney-form');
                this.spineyInput = document.getElementById('spiney-input');
                this.spineyChatWindow = document.getElementById('spiney-chat-window');

                // Event Listeners
                this.setupEventListeners();

                // Initial UI State
                this.navigateTo('home');
                this.braceDate.valueAsDate = new Date();
                this.physioDate.valueAsDate = new Date();
                this.renderSpineyChat();
                this.handleVisitorCounter();

                // Initialize Google Auth Client
                const GOOGLE_CLIENT_ID = "704532323173-lks375tr64fg63iok7bm1sn0slao6nge.apps.googleusercontent.com";
                const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
                
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        if (resp.error !== undefined) {
                           console.log("Silent auth failed, user is logged out.");
                           this.isLoggedIn = false;
                           this.updateUiForAuthState();
                           return;
                        }
                        // Store the access token directly
                        this.accessToken = resp.access_token;
                        
                        this.isLoggedIn = true;
                        await this.fetchUserInfo();
                        await this.findOrCreateDataFile();
                        this.updateUiForAuthState();
                    },
                });

                // Attempt silent sign-in on page load.
                this.tokenClient.requestAccessToken({ prompt: 'none' });
            },

            setupEventListeners() {
                this.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        this.navigateTo(e.target.dataset.page);
                        this.mobileMenu.classList.add('hidden');
                    });
                });

                this.mobileMenuButton.addEventListener('click', () => this.mobileMenu.classList.toggle('hidden'));
                this.loginButton.addEventListener('click', () => this.handleAuthClick());
                this.loginButtonTracker.addEventListener('click', () => this.handleAuthClick());
                this.loginButtonJournal.addEventListener('click', () => this.handleAuthClick());
                this.loginButtonPhysio.addEventListener('click', () => this.handleAuthClick());
                this.logoutButton.addEventListener('click', () => this.handleSignoutClick());
                
                this.braceForm.addEventListener('submit', (e) => this.handleBraceSubmit(e));
                this.physioForm.addEventListener('submit', (e) => this.handlePhysioSubmit(e));
                this.journalForm.addEventListener('submit', (e) => this.handleJournalSubmit(e));
                this.spineyForm.addEventListener('submit', (e) => this.handleSpineySubmit(e));
            },

            handleVisitorCounter() {
                let count = localStorage.getItem('visitorCount') || 0;
                count++;
                localStorage.setItem('visitorCount', count);
                const counterElement = document.getElementById('visitor-counter');
                if(counterElement) {
                    counterElement.textContent = count;
                }
            },

            updateUiForAuthState() {
                if (this.isLoggedIn && this.userInfo) {
                    this.appContainer.classList.add('logged-in');
                    this.loginButton.classList.add('hidden');
                    this.userProfile.classList.remove('hidden');
                    this.userProfile.classList.add('flex');
                    this.userAvatar.src = this.userInfo.picture;
                } else {
                    this.appContainer.classList.remove('logged-in');
                    this.loginButton.classList.remove('hidden');
                    this.userProfile.classList.add('hidden');
                    this.fileId = null;
                    this.braceData = {};
                    this.journalData = [];
                    this.physioData = {};
                    this.loadBraceData();
                    this.loadJournalData();
                    this.loadPhysioData();
                }
            },

            navigateTo(pageId) {
                this.pages.forEach(page => page.classList.remove('active'));
                document.getElementById(`${pageId}-page`).classList.add('active');

                this.navLinks.forEach(link => {
                    link.classList.remove('active-nav');
                     if (link.dataset.page === pageId) link.classList.add('active-nav');
                });
                 document.querySelectorAll('header .nav-link').forEach(link => {
                    link.classList.remove('active-nav');
                    if (link.dataset.page === pageId) link.classList.add('active-nav');
                });
            },

            // --- Google Auth & Drive Methods ---
            handleAuthClick() {
                // If there's no token, request one.
                if (!this.accessToken) {
                    // The 'consent' prompt will show the Google login and permission screen.
                    this.tokenClient.requestAccessToken({ prompt: 'consent' });
                }
            },

            handleSignoutClick() {
                if (this.accessToken) {
                    google.accounts.oauth2.revoke(this.accessToken);
                    this.accessToken = null;
                    this.isLoggedIn = false;
                    this.updateUiForAuthState();
                }
            },
            
            async fetchUserInfo() {
                if (!this.accessToken) return;
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user info');
                    const userInfo = await response.json();
                    this.userInfo = {
                        name: userInfo.name,
                        picture: userInfo.picture,
                    };
                } catch (error) {
                    console.error("Error fetching user info:", error);
                    this.userInfo = null; // Reset on error
                }
            },

            async findOrCreateDataFile() {
                if (!this.accessToken) return;
                try {
                    const response = await fetch("https://www.googleapis.com/drive/v3/files?q=name='beyond-the-curve-data.json'&spaces=appDataFolder&fields=files(id,name)", {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    const data = await response.json();

                    if (data.files && data.files.length > 0) {
                        this.fileId = data.files[0].id;
                        await this.loadDataFromDrive();
                    } else {
                        const fileMetadata = {
                            'name': 'beyond-the-curve-data.json'
                            // CORRECT: When using the 'drive.appdata' scope, you do NOT specify a parent.
                            // The file is automatically placed in the hidden appDataFolder.
                        };
                         const createResponse = await fetch("https://www.googleapis.com/drive/v3/files", {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(fileMetadata)
                        });
                        const newFile = await createResponse.json();
                        this.fileId = newFile.id;
                        await this.saveDataToDrive(); 
                    }
                } catch (err) {
                    console.error("Error finding or creating file", err);
                }
            },

            async loadDataFromDrive() {
                if (!this.fileId || !this.accessToken) return;
                try {
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${this.fileId}?alt=media`, {
                         headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });

                    if (response.status === 200) {
                        const data = await response.json();
                        this.braceData = data.braceData || {};
                        this.journalData = data.journalData || [];
                        this.physioData = data.physioData || {};
                    } else {
                        // Handle empty file case
                        this.braceData = {};
                        this.journalData = [];
                        this.physioData = {};
                    }
                } catch (e) {
                    console.error("Error loading data from Drive", e);
                    this.braceData = {};
                    this.journalData = [];
                    this.physioData = {};
                } finally {
                    this.loadBraceData();
                    this.loadJournalData();
                    this.loadPhysioData();
                }
            },
            
            async saveDataToDrive() {
                if (!this.fileId || !this.accessToken) return;
                const dataToSave = {
                    braceData: this.braceData,
                    journalData: this.journalData,
                    physioData: this.physioData
                };
                try {
                    await fetch(`https://content.googleapis.com/upload/drive/v3/files/${this.fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSave)
                    });
                } catch (err) {
                    console.error("Error saving data to drive", err);
                }
            },

            // --- Gemini API Call ---
            async callGemini(payload) {
                // In a real application, the API key is handled securely by the environment.
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.geminiApiKey}`;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed with status: ${response.status} - ${errorBody.error.message}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Gemini API call error:", error);
                    return { error: `Failed to get a response from the AI. ${error.message}` };
                }
            },

            // --- Brace Tracker Methods ---
            async handleBraceSubmit(e) { e.preventDefault(); const date = this.braceDate.value; const hours = parseFloat(this.braceHours.value); const goal = parseFloat(this.dailyGoal.value); if (!date || isNaN(hours) || isNaN(goal)) { return; } this.braceData[date] = { hours, goal }; await this.saveDataToDrive(); this.updateProgressUI(date); this.updateChart(); this.updateRewards(); this.braceForm.reset(); this.braceDate.valueAsDate = new Date(); },
            loadBraceData() { const today = new Date().toISOString().split('T')[0]; this.updateProgressUI(today); this.updateChart(); this.updateRewards(); },
            updateProgressUI(date) { const data = this.braceData[date]; if (data) { const percentage = Math.min(100, Math.round((data.hours / data.goal) * 100)); this.progressBar.style.width = `${percentage}%`; this.progressBar.textContent = `${percentage}%`; this.progressText.textContent = `You've logged ${data.hours} of ${data.goal} hours today. Keep it up!`; } else { this.progressBar.style.width = '0%'; this.progressBar.textContent = '0%'; this.progressText.textContent = 'Log your hours to see your progress!'; } },
            updateChart() { const ctx = document.getElementById('brace-chart').getContext('2d'); const labels = []; const hoursData = []; const goalData = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const dateString = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('en-US', { weekday: 'short' })); const data = this.braceData[dateString]; hoursData.push(data ? data.hours : 0); goalData.push(data ? data.goal : parseFloat(this.dailyGoal.value)); } if (this.braceChart) { this.braceChart.destroy(); } this.braceChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Hours Worn', data: hoursData, backgroundColor: 'rgba(22, 163, 74, 0.6)' }, { label: 'Goal', data: goalData, type: 'line', fill: false, borderColor: 'rgba(239, 68, 68, 1)' }] }, options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } } }); },
            updateRewards() { const totalDaysLogged = Object.keys(this.braceData).length; const consistentWeeks = this.calculateConsistentWeeks(); const rewards = [ { name: 'First Step', threshold: 1, icon: 'ðŸŒŸ', description: 'Logged your first day!' }, { name: 'Consistent Week', threshold: 7, icon: 'ðŸ“…', description: 'Logged 7 days in a row!' }, { name: '30-Day Warrior', threshold: 30, icon: 'ðŸ›¡ï¸', description: 'Logged for 30 days!' }, { name: 'Perfect Week', threshold: 1, icon: 'ðŸ†', check: consistentWeeks, description: 'Met your goal 7 days in a row!'} ]; this.rewardsContainer.innerHTML = ''; let earnedCount = 0; rewards.forEach(reward => { const checkValue = reward.check !== undefined ? reward.check : totalDaysLogged; const isEarned = checkValue >= reward.threshold; if(isEarned) earnedCount++; const rewardEl = document.createElement('div'); rewardEl.className = `text-center p-2 rounded-lg ${isEarned ? 'bg-green-100' : 'bg-gray-100'}`; rewardEl.innerHTML = `<div class="text-4xl ${isEarned ? '' : 'opacity-30'}">${reward.icon}</div><div class="font-semibold text-sm ${isEarned ? 'text-green-800' : 'text-gray-500'}">${reward.name}</div><div class="text-xs text-gray-500">${reward.description}</div>`; this.rewardsContainer.appendChild(rewardEl); }); if(earnedCount === 0){ this.rewardsContainer.innerHTML = '<p class="text-gray-500">Start logging to earn badges!</p>'; } },
            calculateConsistentWeeks() { const dates = Object.keys(this.braceData).sort(); if(dates.length < 7) return 0; let consecutiveDays = 0; let maxConsecutive = 0; for (let i = 0; i < dates.length; i++) { const data = this.braceData[dates[i]]; if (data.hours >= data.goal) { if (i > 0) { const prevDate = new Date(dates[i-1]); const diffTime = Math.abs(new Date(dates[i]) - prevDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays === 1) consecutiveDays++; else consecutiveDays = 1; } else { consecutiveDays = 1; } } else { consecutiveDays = 0; } if (consecutiveDays > maxConsecutive) maxConsecutive = consecutiveDays; } return Math.floor(maxConsecutive / 7); },
            
            // --- Physiotherapy Tracker Methods ---
            async handlePhysioSubmit(e) { e.preventDefault(); const date = this.physioDate.value; const minutes = parseFloat(this.physioMinutes.value); const goal = parseFloat(this.physioDailyGoal.value); if (!date || isNaN(minutes) || isNaN(goal)) { return; } this.physioData[date] = { minutes, goal }; await this.saveDataToDrive(); this.updatePhysioProgressUI(date); this.updatePhysioChart(); this.updatePhysioRewards(); this.physioForm.reset(); this.physioDate.valueAsDate = new Date(); },
            loadPhysioData() { const today = new Date().toISOString().split('T')[0]; this.updatePhysioProgressUI(today); this.updatePhysioChart(); this.updatePhysioRewards(); },
            updatePhysioProgressUI(date) { const data = this.physioData[date]; if (data) { const percentage = Math.min(100, Math.round((data.minutes / data.goal) * 100)); this.physioProgressBar.style.width = `${percentage}%`; this.physioProgressBar.textContent = `${percentage}%`; this.physioProgressText.textContent = `You've logged ${data.minutes} of ${data.goal} minutes today. Great job!`; } else { this.physioProgressBar.style.width = '0%'; this.physioProgressBar.textContent = '0%'; this.physioProgressText.textContent = 'Log your session to see your progress!'; } },
            updatePhysioChart() { const ctx = document.getElementById('physio-chart').getContext('2d'); const labels = []; const minutesData = []; const goalData = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const dateString = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('en-US', { weekday: 'short' })); const data = this.physioData[dateString]; minutesData.push(data ? data.minutes : 0); goalData.push(data ? data.goal : parseFloat(this.physioDailyGoal.value)); } if (this.physioChart) { this.physioChart.destroy(); } this.physioChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Minutes of PT', data: minutesData, backgroundColor: 'rgba(22, 163, 74, 0.6)' }, { label: 'Goal', data: goalData, type: 'line', fill: false, borderColor: 'rgba(239, 68, 68, 1)' }] }, options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Minutes' } } } } }); },
            updatePhysioRewards() { const totalDaysLogged = Object.keys(this.physioData).length; const consistentWeeks = this.calculateConsistentPTWeeks(); const rewards = [ { name: 'First Session', threshold: 1, icon: 'ðŸ’ª', description: 'Logged your first PT session!' }, { name: 'PT Week', threshold: 7, icon: 'ðŸ—“ï¸', description: 'Logged PT 7 days in a row!' }, { name: 'Month of Motion', threshold: 30, icon: 'ðŸ¤¸', description: 'Logged PT for 30 days!' }, { name: 'Perfect PT Week', threshold: 1, icon: 'ðŸ…', check: consistentWeeks, description: 'Met your PT goal 7 days in a row!'} ]; this.physioRewardsContainer.innerHTML = ''; let earnedCount = 0; rewards.forEach(reward => { const checkValue = reward.check !== undefined ? reward.check : totalDaysLogged; const isEarned = checkValue >= reward.threshold; if(isEarned) earnedCount++; const rewardEl = document.createElement('div'); rewardEl.className = `text-center p-2 rounded-lg ${isEarned ? 'bg-green-100' : 'bg-gray-100'}`; rewardEl.innerHTML = `<div class="text-4xl ${isEarned ? '' : 'opacity-30'}">${reward.icon}</div><div class="font-semibold text-sm ${isEarned ? 'text-green-800' : 'text-gray-500'}">${reward.name}</div><div class="text-xs text-gray-500">${reward.description}</div>`; this.physioRewardsContainer.appendChild(rewardEl); }); if(earnedCount === 0){ this.physioRewardsContainer.innerHTML = '<p class="text-gray-500">Start logging to earn badges!</p>'; } },
            calculateConsistentPTWeeks() { const dates = Object.keys(this.physioData).sort(); if(dates.length < 7) return 0; let consecutiveDays = 0; let maxConsecutive = 0; for (let i = 0; i < dates.length; i++) { const data = this.physioData[dates[i]]; if (data.minutes >= data.goal) { if (i > 0) { const prevDate = new Date(dates[i-1]); const diffTime = Math.abs(new Date(dates[i]) - prevDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays === 1) consecutiveDays++; else consecutiveDays = 1; } else { consecutiveDays = 1; } } else { consecutiveDays = 0; } if (consecutiveDays > maxConsecutive) maxConsecutive = consecutiveDays; } return Math.floor(maxConsecutive / 7); },


            // --- Journal Methods ---
            async handleJournalSubmit(e) { e.preventDefault(); const text = this.journalEntry.value.trim(); if (text === '') return; const newEntry = { id: Date.now(), date: new Date().toISOString(), text: text }; this.journalData.unshift(newEntry); await this.saveDataToDrive(); this.renderJournalEntries(); this.journalForm.reset(); },
            loadJournalData() { this.renderJournalEntries(); },
            renderJournalEntries() {
                this.journalEntriesContainer.innerHTML = '';
                if(this.journalData.length === 0) {
                    this.journalEntriesContainer.innerHTML = '<p class="text-gray-500">Your saved entries will appear here.</p>';
                    return;
                }
                this.journalData.forEach(entry => {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                    const entryDate = new Date(entry.date);
                    entryEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold text-gray-700">${entryDate.toLocaleDateString()} - ${entryDate.toLocaleTimeString()}</p>
                            <button data-id="${entry.id}" class="delete-entry-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button>
                        </div>
                        <p class="text-gray-800 whitespace-pre-wrap">${entry.text}</p>
                        <div class="mt-4">
                            <button data-id="${entry.id}" class="get-reflection-btn bg-teal-500 text-white py-1 px-3 rounded-lg font-semibold text-sm hover:bg-teal-600 transition-colors">âœ¨ Get Reflection</button>
                            <div class="reflection-container mt-2 text-sm" id="reflection-${entry.id}"></div>
                        </div>
                    `;
                    this.journalEntriesContainer.appendChild(entryEl);
                });

                document.querySelectorAll('.delete-entry-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteJournalEntry(e)));
                document.querySelectorAll('.get-reflection-btn').forEach(btn => btn.addEventListener('click', (e) => this.getJournalReflection(e)));
            },
            async deleteJournalEntry(e) {
                const entryId = parseInt(e.target.dataset.id, 10);
                this.journalData = this.journalData.filter(entry => entry.id !== entryId);
                await this.saveDataToDrive();
                this.renderJournalEntries();
            },
            async getJournalReflection(e) { 
                const button = e.target;
                const entryId = parseInt(button.dataset.id, 10);
                const entry = this.journalData.find(e => e.id === entryId);
                const container = document.getElementById(`reflection-${entryId}`);
                if (!entry || !container) return;

                button.disabled = true;
                container.innerHTML = `<p class="text-teal-700">âœ¨ Thinking...</p>`;

                const systemPrompt = "You are an empathetic and encouraging companion. Read the following journal entry from a young person dealing with scoliosis. Your task is to provide a short (1-2 sentences), supportive, and validating reflection on their feelings. Do not give advice. Focus on encouragement and acknowledging their experience.";

                const payload = {
                    contents: [{ parts: [{ text: entry.text }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await this.callGemini(payload);

                if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    const reflectionText = result.candidates[0].content.parts[0].text;
                    container.innerHTML = `<p class="bg-teal-50 p-3 rounded-lg text-teal-800 border border-teal-200">${reflectionText}</p>`;
                } else {
                    container.innerHTML = `<p class="text-red-600">Sorry, I couldn't generate a reflection right now.</p>`;
                    button.disabled = false;
                }
            },
            
            // --- Spiney Methods ---
            async handleSpineySubmit(e) { 
                e.preventDefault();
                const userInput = this.spineyInput.value.trim();
                if (userInput === '') return;

                this.spineyInput.value = '';
                this.spineyChatHistory.push({ role: 'user', text: userInput });
                this.renderSpineyChat();
                this.addTypingIndicator();

                const systemPrompt = "You are Spiney, a friendly, supportive, and empathetic cactus mascot for the 'Beyond the Curve' app. Your purpose is to be a companion for children and teens navigating scoliosis. Answer their general, non-medical questions in a simple, encouraging, and easy-to-understand way. Do not provide medical advice. If asked a medical question, gently refuse and suggest they talk to a doctor or their parents. Keep your answers concise (2-4 sentences).";
                
                const payload = {
                    contents: [{ parts: [{ text: userInput }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }],
                };

                const result = await this.callGemini(payload);
                let spineyResponse = "Sorry, I'm having a little trouble thinking right now. Please try again in a moment.";
                let sources = [];
                
                if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                    spineyResponse = result.candidates[0].content.parts[0].text;
                    const metadata = result.candidates[0].groundingMetadata;
                    if (metadata && metadata.groundingAttributions) {
                        sources = metadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(s => s.uri && s.title);
                    }
                } else if (result && result.error) {
                    spineyResponse = result.error;
                }

                this.spineyChatHistory.push({ role: 'spiney', text: spineyResponse, sources: sources });
                this.renderSpineyChat();
            },
            renderSpineyChat() { 
                this.spineyChatWindow.innerHTML = '';
                if (this.spineyChatHistory.length === 0) {
                    this.spineyChatHistory.push({ role: 'spiney', text: "Hi there! I'm Spiney. How can I help you today?" });
                }

                this.spineyChatHistory.forEach(msg => {
                    const bubble = document.createElement('div');
                    bubble.className = `sp-bubble p-3 rounded-lg ${msg.role === 'user' ? 'user self-end' : 'spiney self-start'}`;
                    bubble.textContent = msg.text;

                    if (msg.sources && msg.sources.length > 0) {
                        const sourcesContainer = document.createElement('div');
                        sourcesContainer.className = 'mt-2 text-xs border-t border-gray-300 pt-2';
                        sourcesContainer.innerHTML = `<h4 class="font-bold mb-1">Sources:</h4>`;
                        const sourceList = document.createElement('ul');
                        sourceList.className = 'list-disc list-inside';
                        msg.sources.forEach((source, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${source.title}</a>`;
                            sourceList.appendChild(li);
                        });
                        sourcesContainer.appendChild(sourceList);
                        bubble.appendChild(sourcesContainer);
                    }
                    this.spineyChatWindow.appendChild(bubble);
                });
                this.spineyChatWindow.scrollTop = this.spineyChatWindow.scrollHeight;
            },
            addTypingIndicator() { 
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'sp-bubble spiney self-start sp-typing-indicator flex items-center gap-1 p-3';
                indicator.innerHTML = `<span class="w-2 h-2 bg-gray-400 rounded-full"></span><span class="w-2 h-2 bg-gray-400 rounded-full"></span><span class="w-2 h-2 bg-gray-400 rounded-full"></span>`;
                this.spineyChatWindow.appendChild(indicator);
                this.spineyChatWindow.scrollTop = this.spineyChatWindow.scrollHeight;
            },
        };

        // --- Global Functions to Bridge Google API Loading ---
        function gapiLoaded() {
            // This function is still needed to ensure the gapi object is loaded for the auth library to use,
            // but we no longer need to initialize the client library.
            app.googleApiReady = true;
            app.init();
        }

        function gisLoaded() {
            app.googleGisReady = true;
            app.init();
        }
    </script>
</body>
</html>

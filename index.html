<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyond the Curve - Your Scoliosis Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .active-nav {
            background-color: #15803d; /* Green-700 */
            color: white;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .sp-bubble {
            max-width: 80%;
        }
        .sp-bubble.user {
            background-color: #bbf7d0; /* Green-200 */
        }
        .sp-bubble.spiney {
            background-color: #f3f4f6; /* Gray-100 */
        }
        .sp-typing-indicator span {
            animation: bounce 1s infinite;
        }
        .sp-typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .sp-typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto min-h-screen bg-white shadow-lg flex flex-col">
        <!-- Header -->
        <header class="bg-green-700 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-2xl font-bold">Beyond the Curve</h1>
            <nav class="hidden md:flex space-x-2">
                <button data-page="home" class="nav-link active-nav px-4 py-2 rounded-lg font-semibold">Home</button>
                <button data-page="tracker" class="nav-link px-4 py-2 rounded-lg font-semibold">Brace Tracker</button>
                <button data-page="journal" class="nav-link px-4 py-2 rounded-lg font-semibold">Journal</button>
                <button data-page="spiney" class="nav-link px-4 py-2 rounded-lg font-semibold">Spiney âœ¨</button>
                <button data-page="resources" class="nav-link px-4 py-2 rounded-lg font-semibold">Resources</button>
            </nav>
            <button id="mobile-menu-button" class="md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-green-600 text-white">
            <nav class="flex flex-col items-center">
                <button data-page="home" class="nav-link w-full text-center py-3">Home</button>
                <button data-page="tracker" class="nav-link w-full text-center py-3">Brace Tracker</button>
                <button data-page="journal" class="nav-link w-full text-center py-3">Journal</button>
                <button data-page="spiney" class="nav-link w-full text-center py-3">Spiney âœ¨</button>
                <button data-page="resources" class="nav-link w-full text-center py-3">Resources</button>
            </nav>
        </div>

        <main class="p-4 md:p-8 flex-grow">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="bg-green-100 border-l-4 border-green-600 text-green-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-2">Welcome to Your Journey Companion</h2>
                    <p class="text-lg">You're not alone. We're here to empower you with tools, community, and resources to build confidence and resilience. Let's navigate this journey together.</p>
                </div>

                <div class="mt-8 grid md:grid-cols-2 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow">
                        <h3 class="text-xl font-bold text-green-700 mb-2">Daily Brace Tracker</h3>
                        <p>Log your brace hours, watch your progress, and earn rewards for your consistency. You've got this!</p>
                        <button data-page="tracker" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">Go to Tracker</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow">
                        <h3 class="text-xl font-bold text-green-700 mb-2">Reflection Journal</h3>
                        <p>A private space to write about your feelings, plus get AI-powered encouragement.</p>
                        <button data-page="journal" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">Open Journal</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow">
                        <h3 class="text-xl font-bold text-green-700 mb-2">Chat with Spiney âœ¨</h3>
                        <p>Your AI companion is here to answer questions and offer support 24/7.</p>
                        <button data-page="spiney" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">Talk to Spiney</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-green-200 transition-shadow">
                        <h3 class="text-xl font-bold text-green-700 mb-2">Vetted Resources</h3>
                        <p>Find surgeons, brace-friendly apparel, support groups, and helpful videos all in one place.</p>
                        <button data-page="resources" class="nav-link mt-4 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">Explore Resources</button>
                    </div>
                </div>
            </div>

            <!-- Brace Tracker Page -->
            <div id="tracker-page" class="page">
                <h2 class="text-3xl font-bold mb-6 text-center">My Brace Tracker</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Log Today's Hours</h3>
                        <form id="brace-form" class="space-y-4">
                            <div>
                                <label for="brace-date" class="block font-semibold">Date</label>
                                <input type="date" id="brace-date" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required>
                            </div>
                            <div>
                                <label for="brace-hours" class="block font-semibold">Hours Worn</label>
                                <input type="number" id="brace-hours" min="0" max="24" step="0.5" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="e.g., 18.5" required>
                            </div>
                            <div>
                                <label for="daily-goal" class="block font-semibold">Daily Goal (hours)</label>
                                <input type="number" id="daily-goal" min="1" max="24" step="1" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="18">
                            </div>
                            <button type="submit" class="w-full bg-green-700 text-white py-2 rounded-lg font-semibold hover:bg-green-800 transition-colors">Log Hours</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Today's Progress</h3>
                        <div id="progress-container">
                            <div class="w-full bg-gray-200 rounded-full h-8">
                                <div id="progress-bar" class="progress-bar-fill bg-green-600 h-8 text-white text-center font-bold leading-8 rounded-full" style="width: 0%;">0%</div>
                            </div>
                            <p id="progress-text" class="text-center mt-2 font-semibold">Log your hours to see your progress!</p>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-xl font-bold mb-4">My Rewards</h3>
                            <div id="rewards-container" class="flex flex-wrap gap-4">
                                <!-- Rewards will be dynamically added here -->
                                <p class="text-gray-500">Start logging to earn badges!</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4">Weekly Progress</h3>
                     <canvas id="brace-chart"></canvas>
                </div>
            </div>

            <!-- Journal Page -->
            <div id="journal-page" class="page">
                <h2 class="text-3xl font-bold mb-6">My Reflection Journal</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <form id="journal-form">
                        <h3 class="text-xl font-bold mb-2">New Entry</h3>
                        <p class="text-gray-600 mb-4">How are you feeling today? This is your private space.</p>
                        <textarea id="journal-entry" class="w-full p-3 border border-gray-300 rounded-lg" rows="8" placeholder="Write about your day, your thoughts, or anything on your mind..."></textarea>
                        <div class="flex justify-end mt-4">
                            <button type="submit" class="bg-green-700 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-800 transition-colors">Save Entry</button>
                        </div>
                    </form>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4">Past Entries</h3>
                    <div id="journal-entries-container" class="space-y-6">
                        <p class="text-gray-500">Your saved entries will appear here.</p>
                    </div>
                </div>
            </div>
            
            <!-- Spiney AI Companion Page -->
            <div id="spiney-page" class="page h-full flex flex-col">
                <div class="text-center mb-4">
                    <br>
                    <h2 class="text-3xl font-bold">Chat with Spiney âœ¨</h2>
                    <p class="text-gray-600">Your friendly AI companion. Ask me anything!</p>
                </div>
                <div id="spiney-chat-window" class="flex-grow bg-white border border-gray-200 rounded-xl p-4 overflow-y-auto space-y-4">
                    <!-- Chat messages will appear here -->
                </div>
                <form id="spiney-form" class="mt-4 flex gap-2">
                    <input type="text" id="spiney-input" class="flex-grow w-full p-3 border border-gray-300 rounded-lg" placeholder="Type your message to Spiney..." autocomplete="off">
                    <button type="submit" class="bg-green-700 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-800 transition-colors disabled:bg-green-300">Send</button>
                </form>
                 <p class="text-xs text-gray-500 mt-2 text-center">Spiney is an AI assistant and may not be 100% accurate. It is not a substitute for medical advice. Please consult a doctor for health concerns.</p>
            </div>


            <!-- Resources Page -->
            <div id="resources-page" class="page">
                 <h2 class="text-3xl font-bold mb-6">Vetted Resources</h2>
                <div class="space-y-8">
                    <!-- Scoliosis Specialists -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-2xl font-bold mb-4 text-green-800">Scoliosis Specialists</h3>
                        <p class="mb-4 text-gray-600">
                            For the most comprehensive and up-to-date directory of specialists, we strongly recommend using the official Scoliosis Research Society (SRS) physician locator. It is the best resource for finding a qualified professional in your area.
                        </p>
                        <a href="https://www.srs.org/Patients/Find-a-Specialist#" target="_blank" rel="noopener noreferrer" class="inline-block bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                            Visit SRS Find a Specialist &rarr;
                        </a>
                    </div>

                    <!-- Other Resources -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Video Library -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Video Library</h3>
                            <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Understanding Scoliosis</a></li>
                                <li><a href="#" class="hover:underline">Physical Therapy Exercises</a></li>
                                <li><a href="#" class="hover:underline">Inspiring Patient Stories</a></li>
                                <li><a href="#" class="hover:underline">Bracing: Tips & Tricks</a></li>
                            </ul>
                        </div>
                        <!-- Brace-Friendly Apparel -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Brace-Friendly Apparel</h3>
                             <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Hope's Closet</a></li>
                                <li><a href="#" class="hover:underline">Brace-Tee</a></li>
                                <li><a href="#" class="hover:underline">Embraced in Comfort</a></li>
                            </ul>
                        </div>
                        <!-- Support Groups -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-green-800">Support Groups</h3>
                             <ul class="space-y-3 list-disc list-inside text-green-700">
                                <li><a href="#" class="hover:underline">Curvy Girls International</a></li>
                                <li><a href="#" class="hover:underline">ScoliBoys Support</a></li>
                                <li><a href="#" class="hover:underline">Higgy Bears</a></li>
                                <li><a href="https://www.bracingforscoliosus.org/" target="_blank" rel="noopener noreferrer" class="hover:underline">Bracing for Scoliosis</a></li>
                                 <li><a href="#" class="hover:underline">Parents of Scoliosis Facebook Group</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // STATE
                apiKey: "", // API Key will be injected by the environment
                pages: document.querySelectorAll('.page'),
                navLinks: document.querySelectorAll('.nav-link'),
                mobileMenuButton: document.getElementById('mobile-menu-button'),
                mobileMenu: document.getElementById('mobile-menu'),

                // Brace Tracker
                braceForm: document.getElementById('brace-form'),
                braceDate: document.getElementById('brace-date'),
                braceHours: document.getElementById('brace-hours'),
                dailyGoal: document.getElementById('daily-goal'),
                progressBar: document.getElementById('progress-bar'),
                progressText: document.getElementById('progress-text'),
                rewardsContainer: document.getElementById('rewards-container'),
                braceChart: null,
                braceData: JSON.parse(localStorage.getItem('braceData')) || {},

                // Journal
                journalForm: document.getElementById('journal-form'),
                journalEntry: document.getElementById('journal-entry'),
                journalEntriesContainer: document.getElementById('journal-entries-container'),
                journalData: JSON.parse(localStorage.getItem('journalData')) || [],

                // Spiney AI Companion
                spineyForm: document.getElementById('spiney-form'),
                spineyInput: document.getElementById('spiney-input'),
                spineyChatWindow: document.getElementById('spiney-chat-window'),
                spineyChatHistory: [],

                // Resources
                // Surgeon search removed

                // METHODS
                init() {
                    this.setupEventListeners();
                    this.navigateTo('home');
                    this.braceDate.valueAsDate = new Date();
                    this.loadBraceData();
                    this.loadJournalData();
                    // this.renderSurgeons(); // Removed
                    this.renderSpineyChat();
                },

                setupEventListeners() {
                    this.navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            this.navigateTo(e.target.dataset.page);
                            this.mobileMenu.classList.add('hidden');
                        });
                    });

                    this.mobileMenuButton.addEventListener('click', () => this.mobileMenu.classList.toggle('hidden'));
                    
                    this.braceForm.addEventListener('submit', (e) => this.handleBraceSubmit(e));
                    this.journalForm.addEventListener('submit', (e) => this.handleJournalSubmit(e));
                    this.spineyForm.addEventListener('submit', (e) => this.handleSpineySubmit(e));
                    // this.surgeonSearch.addEventListener('input', () => this.renderSurgeons()); // Removed
                },

                navigateTo(pageId) {
                    this.pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(`${pageId}-page`).classList.add('active');

                    this.navLinks.forEach(link => {
                        link.classList.remove('active-nav');
                         if (link.dataset.page === pageId) link.classList.add('active-nav');
                    });
                     // Special case for header nav links
                    document.querySelectorAll('header .nav-link').forEach(link => {
                        link.classList.remove('active-nav');
                        if (link.dataset.page === pageId) link.classList.add('active-nav');
                    });
                },

                // --- Gemini API Call ---
                async callGemini(payload, retries = 3, delay = 1000) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.apiKey}`;
                    
                    for (let i = 0; i < retries; i++) {
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();
                            const candidate = result.candidates?.[0];

                            if (candidate && candidate.content?.parts?.[0]?.text) {
                                const text = candidate.content.parts[0].text;
                                let sources = [];
                                const groundingMetadata = candidate.groundingMetadata;
                                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                    sources = groundingMetadata.groundingAttributions
                                        .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                        .filter(source => source.uri && source.title);
                                }
                                return { text, sources };
                            } else {
                                throw new Error("Invalid response structure from Gemini API");
                            }
                        } catch (error) {
                            console.error(`Attempt ${i + 1} failed:`, error);
                            if (i < retries - 1) {
                                await new Promise(res => setTimeout(res, delay));
                                delay *= 2; // Exponential backoff
                            } else {
                                return { text: "Sorry, I'm having trouble connecting right now. Please try again later.", sources: [] };
                            }
                        }
                    }
                },


                // --- Brace Tracker Methods ---
                handleBraceSubmit(e) { e.preventDefault(); const date = this.braceDate.value; const hours = parseFloat(this.braceHours.value); const goal = parseFloat(this.dailyGoal.value); if (!date || isNaN(hours) || isNaN(goal)) { return; } this.braceData[date] = { hours, goal }; localStorage.setItem('braceData', JSON.stringify(this.braceData)); this.updateProgressUI(date); this.updateChart(); this.updateRewards(); this.braceForm.reset(); this.braceDate.valueAsDate = new Date(); },
                loadBraceData() { const today = new Date().toISOString().split('T')[0]; this.updateProgressUI(today); this.updateChart(); this.updateRewards(); },
                updateProgressUI(date) { const data = this.braceData[date]; if (data) { const percentage = Math.min(100, Math.round((data.hours / data.goal) * 100)); this.progressBar.style.width = `${percentage}%`; this.progressBar.textContent = `${percentage}%`; this.progressText.textContent = `You've logged ${data.hours} of ${data.goal} hours today. Keep it up!`; } else { this.progressBar.style.width = '0%'; this.progressBar.textContent = '0%'; this.progressText.textContent = 'Log your hours to see your progress!'; } },
                updateChart() { const ctx = document.getElementById('brace-chart').getContext('2d'); const labels = []; const hoursData = []; const goalData = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const dateString = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('en-US', { weekday: 'short' })); const data = this.braceData[dateString]; hoursData.push(data ? data.hours : 0); goalData.push(data ? data.goal : parseFloat(this.dailyGoal.value)); } if (this.braceChart) { this.braceChart.destroy(); } this.braceChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Hours Worn', data: hoursData, backgroundColor: 'rgba(22, 163, 74, 0.6)' }, { label: 'Goal', data: goalData, type: 'line', fill: false, borderColor: 'rgba(239, 68, 68, 1)' }] }, options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } } }); },
                updateRewards() { const totalDaysLogged = Object.keys(this.braceData).length; const consistentWeeks = this.calculateConsistentWeeks(); const rewards = [ { name: 'First Step', threshold: 1, icon: 'ðŸŒŸ', description: 'Logged your first day!' }, { name: 'Consistent Week', threshold: 7, icon: 'ðŸ“…', description: 'Logged 7 days in a row!' }, { name: '30-Day Warrior', threshold: 30, icon: 'ðŸ›¡ï¸', description: 'Logged for 30 days!' }, { name: 'Perfect Week', threshold: 1, icon: 'ðŸ†', check: consistentWeeks, description: 'Met your goal 7 days in a row!'} ]; this.rewardsContainer.innerHTML = ''; let earnedCount = 0; rewards.forEach(reward => { const checkValue = reward.check !== undefined ? reward.check : totalDaysLogged; const isEarned = checkValue >= reward.threshold; if(isEarned) earnedCount++; const rewardEl = document.createElement('div'); rewardEl.className = `text-center p-2 rounded-lg ${isEarned ? 'bg-green-100' : 'bg-gray-100'}`; rewardEl.innerHTML = `<div class="text-4xl ${isEarned ? '' : 'opacity-30'}">${reward.icon}</div><div class="font-semibold text-sm ${isEarned ? 'text-green-800' : 'text-gray-500'}">${reward.name}</div><div class="text-xs text-gray-500">${reward.description}</div>`; this.rewardsContainer.appendChild(rewardEl); }); if(earnedCount === 0){ this.rewardsContainer.innerHTML = '<p class="text-gray-500">Start logging to earn badges!</p>'; } },
                calculateConsistentWeeks() { const dates = Object.keys(this.braceData).sort(); if(dates.length < 7) return 0; let consecutiveDays = 0; let maxConsecutive = 0; for (let i = 0; i < dates.length; i++) { const data = this.braceData[dates[i]]; if (data.hours >= data.goal) { if (i > 0) { const prevDate = new Date(dates[i-1]); const diffTime = Math.abs(new Date(dates[i]) - prevDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays === 1) consecutiveDays++; else consecutiveDays = 1; } else { consecutiveDays = 1; } } else { consecutiveDays = 0; } if (consecutiveDays > maxConsecutive) maxConsecutive = consecutiveDays; } return Math.floor(maxConsecutive / 7); },

                // --- Journal Methods ---
                handleJournalSubmit(e) { e.preventDefault(); const text = this.journalEntry.value.trim(); if (text === '') return; const newEntry = { id: Date.now(), date: new Date().toISOString(), text: text }; this.journalData.unshift(newEntry); localStorage.setItem('journalData', JSON.stringify(this.journalData)); this.renderJournalEntries(); this.journalForm.reset(); },
                loadJournalData() { this.renderJournalEntries(); },
                renderJournalEntries() {
                    this.journalEntriesContainer.innerHTML = '';
                    if(this.journalData.length === 0) {
                        this.journalEntriesContainer.innerHTML = '<p class="text-gray-500">Your saved entries will appear here.</p>';
                        return;
                    }
                    this.journalData.forEach(entry => {
                        const entryEl = document.createElement('div');
                        entryEl.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        const entryDate = new Date(entry.date);
                        entryEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <p class="font-semibold text-gray-700">${entryDate.toLocaleDateString()} - ${entryDate.toLocaleTimeString()}</p>
                                <button data-id="${entry.id}" class="delete-entry-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap">${entry.text}</p>
                            <div class="mt-4">
                                <button data-id="${entry.id}" class="get-reflection-btn bg-teal-500 text-white py-1 px-3 rounded-lg font-semibold text-sm hover:bg-teal-600 transition-colors">âœ¨ Get Reflection</button>
                                <div class="reflection-container mt-2 text-sm" id="reflection-${entry.id}"></div>
                            </div>
                        `;
                        this.journalEntriesContainer.appendChild(entryEl);
                    });

                    document.querySelectorAll('.delete-entry-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteJournalEntry(e)));
                    document.querySelectorAll('.get-reflection-btn').forEach(btn => btn.addEventListener('click', (e) => this.getJournalReflection(e)));
                },
                deleteJournalEntry(e) {
                    const entryId = parseInt(e.target.dataset.id, 10);
                    this.journalData = this.journalData.filter(entry => entry.id !== entryId);
                    localStorage.setItem('journalData', JSON.stringify(this.journalData));
                    this.renderJournalEntries();
                },
                async getJournalReflection(e) {
                    const button = e.target;
                    const entryId = parseInt(button.dataset.id, 10);
                    const entry = this.journalData.find(entry => entry.id === entryId);
                    const container = document.getElementById(`reflection-${entryId}`);

                    if (!entry || !container) return;
                    
                    button.disabled = true;
                    container.innerHTML = `<p class="text-teal-700">Thinking...</p>`;

                    const systemPrompt = "You are a caring and supportive friend. Read the following journal entry from a young person dealing with scoliosis. Summarize their feelings in one sentence and then provide a short, encouraging, and empathetic response in a new paragraph. Do not give medical advice. Keep your response under 75 words.";
                    const payload = {
                        contents: [{ parts: [{ text: entry.text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const result = await this.callGemini(payload);

                    container.innerHTML = `<div class="bg-teal-50 p-3 rounded-md border border-teal-200">${result.text.replace(/\n/g, '<br>')}</div>`;
                    button.disabled = false;
                },
                
                // --- Spiney AI Companion Methods ---
                async handleSpineySubmit(e) {
                    e.preventDefault();
                    const userInput = this.spineyInput.value.trim();
                    if(userInput === '') return;
                    
                    this.spineyChatHistory.push({ role: 'user', text: userInput });
                    this.renderSpineyChat();
                    this.spineyInput.value = '';
                    this.spineyForm.querySelector('button').disabled = true;
                    
                    // Show typing indicator
                    const typingEl = this.addTypingIndicator();

                    const systemPrompt = "You are Spiney, a friendly and supportive AI companion for kids and teens with scoliosis. Your goal is to provide encouragement, answer non-medical questions, and be a good listener. Use simple, positive language. When asked for information about scoliosis, treatment, or related topics, use the provided search tool to find accurate information and cite your sources. Never provide medical advice. If asked for medical advice, gently redirect the user to talk to their doctor or a trusted adult.";
                    const payload = {
                        contents: [{ parts: [{ text: userInput }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };

                    const result = await this.callGemini(payload);

                    // Remove typing indicator
                    typingEl.remove();

                    this.spineyChatHistory.push({ role: 'spiney', text: result.text, sources: result.sources });
                    this.renderSpineyChat();
                    this.spineyForm.querySelector('button').disabled = false;
                },
                renderSpineyChat() {
                    this.spineyChatWindow.innerHTML = '';
                    this.spineyChatHistory.forEach(msg => {
                        const msgEl = document.createElement('div');
                        const isUser = msg.role === 'user';
                        msgEl.className = `sp-bubble p-3 rounded-lg flex flex-col ${isUser ? 'user self-end' : 'spiney self-start'}`;

                        let html = `<p class="whitespace-pre-wrap">${msg.text}</p>`;
                        if (msg.sources && msg.sources.length > 0) {
                            html += '<div class="mt-2 pt-2 border-t border-gray-300"><p class="font-semibold text-xs mb-1">Sources:</p><ol class="list-decimal list-inside text-xs">';
                            msg.sources.forEach(source => {
                                html += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">${source.title}</a></li>`;
                            });
                            html += '</ol></div>';
                        }
                        msgEl.innerHTML = html;
                        this.spineyChatWindow.appendChild(msgEl);
                    });
                    this.spineyChatWindow.scrollTop = this.spineyChatWindow.scrollHeight;
                },
                addTypingIndicator() {
                     const typingEl = document.createElement('div');
                     typingEl.className = 'sp-bubble spiney self-start p-3 rounded-lg sp-typing-indicator flex items-center space-x-1';
                     typingEl.innerHTML = `
                        <span class="block w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="block w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="block w-2 h-2 bg-gray-400 rounded-full"></span>
                     `;
                     this.spineyChatWindow.appendChild(typingEl);
                     this.spineyChatWindow.scrollTop = this.spineyChatWindow.scrollHeight;
                     return typingEl;
                },
                
                // --- Resources Methods ---
                // renderSurgeons method removed
            };
            
            app.init();
        });
    </script>
</body>
</html>

